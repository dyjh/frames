<extend name="Public/index" />
<block name="banner">
    <div class="height_60"></div>
    <div class="subbanner-small" onclick="LinkTo();">
        <div class="subbanner-inner">
            <div class="container">
                <!--<h1>攻略资料</h1>-->
                <h1></h1>
                <!--<h2>Strategy</h2>-->
                <h2></h2>
                <img class="col-md-4 col-md-offset-1 col-xs-10 col-xs-offset-1" src="__FILEADD__/content/images/matching.png" style="margin-top: 1%;"/>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var banners = [];
        {:W('Banner/Market')}
        if (banners.length > 0) {
            $(".subbanner-inner").hide();
            $(".subbanner-small").attr("style", "cursor:pointer;");
            images = [];
            for (i = 0; i < banners.length; i++) {
                images.push(banners[i]["img"]);
            }
        }

        $(function () {
            $('.subbanner-small').backstretch(images, { fade: 750, duration: 3000 });
        });


    </script>
</block>
<block name="content">

    <script src="__HIGHSTOCK__/highstock.js"></script>
    <script src="__HIGHSTOCK__/Market_Detail.js"></script>
    <script src="__HIGHSTOCK__/modules/exporting.js"></script>

    <script src="__FILEADD__/content/js/wow.min.js"></script>
   
    <script src="__FILEADD__/content/js/utilities.js"></script>

    <!--<div id="container" class="Highcharts" style="width: 100%;margin-right: 15px;"></div>-->

        <div class="container">
        <div class="kline">
            <dl class="kline-head clear">
                <dt class="color-1">
                    <img src="__COMMON__/img/{$seed}.png">
                <div class="price" id="FlushPrice1">{$MarketInfo.MarketInfo.Price}</div>
                <div class="rise">
                    <cite>涨额：<em id="FlushIncrease">
                        {$MarketInfo.MarketInfo.Increase}
                    </em></cite>
                    <cite>涨幅：<em id="FlushIncreaseRate">
                        {$MarketInfo.MarketInfo.IncreaseRate}%
                    </em></cite>
                </div>
                </dt>

                <dd>
                    <span>今开</span>
                    <cite>{$MarketInfo.MarketInfo.OpenPrice}</cite>
                </dd>
                <dd>
                    <span>最低</span>
                    <cite id="FluashLowestPrice">{$MarketInfo.MarketInfo.LowestPrice}</cite>
                </dd>
                <dd>
                    <span>最高</span>
                    <cite id="FluashHighestPrice">{$MarketInfo.MarketInfo.HighestPrice}</cite>
                </dd>
                <dd>
                    <span>成交</span>
                    <cite id="FluashVolume">{$MarketInfo.MarketInfo.Volume}</cite>
                </dd>

            </dl>

            <div class="kline-main">
                <div class="kline-switch">
                    <span id="mbtn" onclick="Minute('{$seed}','<?php echo U("User/ajax_min")?>'); $('.kline-switch span').removeClass('select'); $(this).addClass('select');" class="">分时</span>
                    <span id="kbtn" onclick="$('.Highcharts').toggle(); $('.kline-switch span').removeClass('select'); $(this).addClass('select');$('.kline-ma').show();" class="select">日K</span>
                </div>
                <div class="flush-switch">自动刷新</div>
                <div class="kline-ma">
                    <div class="ma05 clear"><i></i><b>MA05</b></div>
                    <div class="ma10 clear"><i></i><b>MA10</b></div>
                    <div class="ma30 clear"><i></i><b>MA30</b></div>
                </div>
                <div id="kline" class="kline-chart Highcharts">
                    <div id="loading" class="kline-chart-loading">
                        <div class="rect1">&nbsp;</div>
                        <div class="rect2">&nbsp;</div>
                        <div class="rect3">&nbsp;</div>
                        <div class="rect4">&nbsp;</div>
                        <div class="rect5">&nbsp;</div>
                    </div>
                </div>
                <div id="container" class="kline-chart Highcharts">
                    <div id="" class="kline-chart-loading">
                        <div class="rect1">&nbsp;</div>
                        <div class="rect2">&nbsp;</div>
                        <div class="rect3">&nbsp;</div>
                        <div class="rect4">&nbsp;</div>
                        <div class="rect5">&nbsp;</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
        <div class="container">
            <ul class="product-switch clear">
                <volist name="AllSeedList" id="seeds">
                    <li>
                        <a href="{:U('User/Market_Detail','procode='.$seeds['varieties'])}">{$seeds.varieties}</a>
                    </li>
                </volist>
            </ul>
        </div>
        <div class="container clear">

            <div class="trade-form">
                <dl class="headbox clear">

                    <dd><span>产品：</span><em class="color-4">{$seed}</em></dd>
                    <dd><span>现价：</span><em class="color-4" id="FlushPrice2">{$MarketInfo.MarketInfo.Price}</em></dd>
                    <dd><span>涨停：</span><em id="limitUp">{$MarketInfo.MarketInfo.LimitUp}</em></dd>
                    <dd><span>跌停：</span><em id="limitDown">{$MarketInfo.MarketInfo.LimitDown}</em></dd>
                </dl>
                <div class="formbox clear">

                    <div class="sale">
						<div class="form-group">
						<h2 class="color-4"><i class="icon">&#xe61c;</i>卖出</h2>
							<!--<h2 class="color-4"  style="float:left; width:73%;"><i class="icon">&#xe61c;</i>卖出</h2>
							<select name="sweeping" id="ch_sale" style="float:left;margin-top:8%;"  onchange="ch_sale()">
								<option value="0">正常</option>
								<option value="1">市价</option>								
							</select>-->
						</div>                       
                        <div class="form-group">
                            <div class="form-group-addon">卖出价格</div>
                            <div class="form-group-input stretch">
                                <input class="no-left-border no-right-border stretch" data-val="true" data-val-number="字段 SalePrice 必须是一个数字。" data-val-required="SalePrice 字段是必需的。" id="SalePrice" name="SalePrice" type="text" value="0" />
								<!--<select class="no-left-border no-right-border stretch" id="se_sale" style="display:none; height:45px; border-bottom:1px solid #ddd; border-top:1px solid #ddd;">
									<for start="1" end="6">
										<if condition="$MarketInfo['BuyList'][$i-1]['Price'] eq ''">
										<else/>
										<option value="{$MarketInfo['BuyList'][$i-1]['Price']}">{$MarketInfo['BuyList'][$i-1]['Price']}</option>
										</if>
									</for>
								</select>-->
                            </div>
                            <div class="form-group-addon no-left-border form-group-addon-white">金币</div>
                        </div>
                        <div class="form-group">
                            <div class="form-group-addon">卖出数量</div>
                            <div class="form-group-input stretch">
                                <input class="stretch 1no-right-border no-left-border" data-val="true" data-val-number="字段 SaleCount 必须是一个数字。" id="SaleCount" name="SaleCount" type="text" value="" />
                            </div>
                            <div class="form-group-addon no-left-border form-group-addon-white"><a href="javascript:max({$user_has_seed.user_has_seed_num})">最大</a></div>
                            <div class="form-group-input">
                                <!-- <button toggle="#saletogglebox" onclick="return false">% <i class="icon">&#xe610;</i></button> -->
                                <div class="togglebox togglebox-top togglebox-right" id="saletogglebox">
                                    <dl>
                                        <dd onclick="SalePersent(1.00)">100%</dd>
                                        <dd onclick="SalePersent(0.75)">75%</dd>
                                        <dd onclick="SalePersent(0.50)">50%</dd>
                                        <dd onclick="SalePersent(0.25)">25%</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-group-addon">总计金币</div>
                            <div class="form-group-input stretch">
                                <input type="text" id="saletotalmoney" name="saletotalmoney" value="0.0000" class="stretch no-right-border no-left-border"  maxlength="7" />
                            </div>
                            <div class="form-group-addon no-left-border form-group-addon-white">金币</div>
                        </div>
                        <div class="form-group clear">
                            <div class="text-left">
                                持有量:<span class="color-1" id="hasnumber">{$user_has_seed.user_has_seed_num}</span>
                            </div>
                            <div class="text-right">
                                手续费:<span class="color-1" id="salechargemoney">{$salecharge}</span>金币
                            </div>
                        </div>

                        <if condition="$user_info['level'] gt 4">
                            <div class="form-group no-padding-bottom">
                                <input type="button" class="button-color-4 button-stretch" value="限价卖出" onclick="Sale()" />
                            </div>
                            <else/>
                            <div class="form-group no-padding-bottom">
                                <input type="button" class="button-color-4 button-stretch" value="须达到5级才能卖出"/> 
                            </div>
                        </if>

                    </div>
					
                    <div class="buy">
						<div class="form-group">
							<h2 class="color-1"><i class="icon">&#xe609;</i>买入</h2>
							<!--<h2 class="color-1" style="float:left; width:73%;"><i class="icon">&#xe609;</i>买入</h2>
							<select  name="sweeping" id="ch_buy" style="float:left;margin-top:8%;" onchange="ch_buy()">
								<option value="0">正常</option>
								<option value="1">市价</option>
							</select>-->
						</div>
                        <div class="form-group">
                            <div class="form-group-addon">买入价格</div>
                            <div class="form-group-input stretch">
                                <input class="no-left-border no-right-border stretch" data-val="true" data-val-number="字段 BuyPrice 必须是一个数字。" data-val-required="BuyPrice 字段是必需的。" id="BuyPrice" name="BuyPrice" type="text" value="0" />
								<!--<select class="no-left-border no-right-border stretch" id="se_buy"  style="display:none;height:45px; border-bottom:1px solid #ddd; border-top:1px solid #ddd;">
									<for start="1" end="6">
										<if condition="$MarketInfo['SaleList'][$i-1]['Price'] eq ''">
										<else/>
										<option value="{$MarketInfo['SaleList'][$i-1]['Price']}">{$MarketInfo['SaleList'][$i-1]['Price']}</option>
										</if>
									</for>
								</select>-->
                            </div>
                            <div class="form-group-addon no-left-border form-group-addon-white">金币</div>
                        </div>
                        <div class="form-group">
                            <div class="form-group-addon">买入数量</div>
                            <div class="form-group-input stretch">
                                <input class="stretch  no-left-border" data-val="true" data-val-number="字段 BuyCount 必须是一个数字。" id="BuyCount" name="BuyCount" type="text" value="" />
                            </div>
							<div class="form-group-addon no-left-border form-group-addon-white"><a href="javascript:max_coin({$user_info.coin})">最大</a></div>
                            <div class="form-group-input">
                                <!-- <button toggle="#buytogglebox" onclick="return false">%<i class="icon">&#xe610;</i></button> -->
                                <div class="togglebox togglebox-top togglebox-right" id="buytogglebox">
                                    <dl>
                                        <dd onclick="BuyPersent(1.00)">100%</dd>
                                        <dd onclick="BuyPersent(0.75)">75%</dd>
                                        <dd onclick="BuyPersent(0.50)">50%</dd>
                                        <dd onclick="BuyPersent(0.25)">25%</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="form-group-addon">总计金币</div>

                            <div class="form-group-input stretch">
                                <input type="text" id="buytotalmoney" name="buytotalmoney" value="0.0000" class="stretch no-right-border no-left-border" maxlength="7" />
                            </div>

                            <div class="form-group-addon no-left-border form-group-addon-white">金币</div>
                        </div>
                        <div class="form-group clear">
                            <div class="text-left">
                                可用金币:<span class="color-1" id="hasmoney">{$user_info.coin}</span>金币
                            </div>
                            <div class="text-right">
                                手续费:<span class="color-1" id="buychargemoney">无</span>
                            </div>
                        </div>


                            <div class="form-group no-padding-bottom">
                                <input type="button" class="button-color-1 button-stretch" value="限价买入" onclick="Buy()" />
                            </div>
                        
                    </div>

                </div>
            </div>

            <div class="trade-entrust">
                <h3 class="color-1">委托信息</h3>
                <div class="tablebox">
                    <table>
                        <thead>
                        <tr>
                            <th>买/卖</th>
                            <th>价格</th>
                            <th>委托量</th>
                        </tr>
                        </thead>
                        <tbody id="entrust">

                        <reduce start="5" end="0">
                            <tr class="bgsale">
                                <td class="color-4">卖{$i|change_capital=###}</td>
                                <td class="color-1"><em>{$MarketInfo['SaleList'][$i-1]['Price']}</em></td>
                                <td><em>{$MarketInfo['SaleList'][$i-1]['Number']}</em></td>
                            </tr>
                        </reduce>

                        <for start="1" end="6">
                            <tr class="bgbuy">
                                <td class="color-2">买{$i|change_capital=###}</td>
                                <td class="color-1"><em>{$MarketInfo['BuyList'][$i-1]['Price']}</em></td>
                                <td><em>{$MarketInfo['BuyList'][$i-1]['Number']}</em></td>
                            </tr>
                        </for>

                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        <div class="container">
            <div class="trade-entrust-my">
                <h3 class="color-1">当前委托<span style="position:absolute; right:0; font-weight:normal; cursor:pointer;" onclick="return false;  FlushMyEntrust();" >
                    <!--【刷新】-->
                </span></h3>
                <div class="tablebox">
                    <table>
                        <thead>
                        <tr>
                            <th><span class="color-1" style="cursor:pointer;" onclick=" return false;   Revokes()">[撤消]</span></th>
                            <th>委托时间</th>
                            <th>产品</th>
                            <th>类型</th>
                            <th>价格</th>
                            <th>委托量</th>
                            <th>剩余量</th>
                            <th>状态</th>
                        </tr>
                        </thead>

                        <tbody id="MyEntrust0">

                        <if condition="$NowEntrustList">
                            <volist name="NowEntrustList" id="val">
                                <tr>
                                    <td>
                                        <button class="revoke_{$val.id}" onclick="ConfirmRevokeEntrust('{$val.id}','{$val.time}')"> 撤销</button>
                                    </td>
                                    <td  valign="middle">
                                        {$val.time|date="Y-m-d",###}
                                    </td>
                                    <td  valign="middle">
                                        {$val.seed}
                                    </td>
                                    <td  valign="middle">
                                        <if condition="$val['type'] eq 1">
                                            买入
                                            <else/>
                                            卖出
                                        </if>
                                    </td>
                                    <td  valign="middle">
                                        {$val.money}
                                    </td>
                                    <td  valign="middle">
                                        {$val.submit_num}
                                    </td>
                                    <td  valign="middle">
                                        {$val.num}
                                    </td>
                                    <td  valign="middle" class="states_{$val.id}">
                                        <if condition="$val['state'] eq 1">
                                            交易中
                                            <elseif condition="$val['state'] eq 2"/>
                                            交易完成
                                            <elseif condition="$val['state'] eq 3"/>
                                            被撤销
                                            <else/>
                                            未交易
                                        </if>
                                    </td>
                                </tr>
                            </volist>
                            <else/>
                            <tr>
                                <td colspan="8" align="center">
                                    <p style="padding: 15px;">暂无数据信息</p>
                                </td>
                            </tr>
                        </if>

                        </tbody>
                    </table>
                </div>

                <div class="thepager clear" id="thepager0"></div>


            </div>

            <div class="trade-entrust-my" style="padding-top:0;">
                <h3 class="color-1">历史交易<span style="position:absolute; right:0; font-weight:normal; cursor:pointer;"></span></h3>
                <div class="tablebox">
                    <table>
                        <thead>
                        <tr>
                            <th>时间</th>
                            <th>产品</th>
                            <th>价格</th>
                            <th>数量</th>
                            <th>类型</th>
                        </tr>
                        </thead>

                        <tbody id="MyEntrust1">
                        <if condition="$HistorySaleList">
                            <volist name="HistorySaleList" id="val">
                                <tr>
                                    <td  valign="middle">
                                        {$val.time|date="Y-m-d",###}
                                    </td>
                                    <td  valign="middle">
                                        {$val.seed}
                                    </td>
                                    <td  valign="middle">
                                        {$val.money}
                                    </td>
                                    <td  valign="middle">
                                        {$val.submit_num}
                                    </td>
                                    <td  valign="middle">
                                        <if condition="$val['type'] eq 1"> 买入<else/> 卖出</if>
                                    </td>
                                </tr>
                            </volist>
                            <else/>
                            <tr>
                                <td colspan="5" align="center">
                                    <p style="padding: 15px;">暂无数据信息</p>
                                </td>
                            </tr>
                        </if>
                        </tbody>
                    </table>
                </div>

                <div class="thepager clear" id="thepager1"></div>

            </div>

        </div>
        <div class="container padding-bottom">
            <div class="message message-warn">
                温馨提示：<br />
                1.
                交易数量以整百倍进行交易。        <br />
                <!--2.-->
                <!--种子出售手续费20%，每日涨跌额0.0003。        <br />-->
                <!--
                3.交易时段为每天09:00至次日00:00，特殊停盘除外。<br />
                4.非交易时段无法进行买卖委托和委托撤销。<br />
                -->
                <!--3.领取推广大礼包后，需将农场等级提升到4级后方可在淘金果园出售种子和果实。-->
            </div>
        </div>



    <script type="text/javascript">
	    function max(num){
	        num=Math.floor(num/100);
	        num=num*100;
	        $('#SaleCount').val(num);
        }
		function max_coin(coin){
			//alert(coin);
			var money=$('#BuyPrice').val();
			
	        num=Math.floor(coin/money);
	        //num=num*100;
	        $('#BuyCount').val(num);
        }
	    KLine(  "{:U('User/ajax_k')}",'{$seed}');
	 
		function ch_buy(){
			var type_buy=$("#ch_buy").val();
//			alert(type_buy);
			if(type_buy==1){
				$("#BuyPrice").css("display","none");
				$("#BuyPrice").attr("name","");
				$("#se_buy").css("display","block");
				$("#se_buy").attr("name","BuyPrice");
				$("#BuyPrice").attr("id","buy_style");
				$("#se_buy").attr("id","BuyPrice");
			}else{
				$("#BuyPrice").attr("id","se_buy");
				$("#buy_style").attr("id","BuyPrice");
				$("#se_buy").css("display","none");
				$("#se_buy").attr("name","");
				$("#BuyPrice").css("display","block");
				$("#BuyPrice").attr("name","BuyPrice");
			}
		}
		function ch_sale(){
			var type_sale=$("#ch_sale").val();
//			alert(type_sale);
			if(type_sale==1){
				$("#SalePrice").css("display","none");
				$("#SalePrice").attr("name","");
				$("#se_sale").css("display","block");
				$("#se_sale").attr("name","SalePrice");
				$("#SalePrice").attr("id","sale_style");
				$("#se_sale").attr("id","SalePrice");
			}else{
				$("#SalePrice").attr("id","se_sale");
				$("#sale_style").attr("id","SalePrice");
				$("#se_sale").css("display","none");
				$("#se_sale").attr("name","");
				$("#SalePrice").css("display","block");
				$("#SalePrice").attr("name","SalePrice");
			}
		}
        var hasmoney = $("#hasmoney").html();		//余额
        var hasnumber = $("#hasnumber").html();		//持有

        var AutoFlush = false;

        var  intFormatFloat = 7;
		var  BuySaleFloat = 5;

        var salecharge = "{$salecharge}";

        $(function () {

            if('' != ""){
                alert('');
            }

            $("#EIds").val("");

            $(".flush-switch").click(function () {
                if ($(this).hasClass("flush-switch-select")) {
                    $(this).removeClass("flush-switch-select");
                    $(this).addClass("flush-switch");
                    AutoFlush = false;
                } else {
                    $(this).removeClass("flush-switch");
                    $(this).addClass("flush-switch-select");

                    //在交易时间段才刷新
                    var h = new Date().getHours();
                    if(h>=9)
                    {
                        AutoFlush = true;
                    }
                }
            });

            KLine(  "{:U('User/ajax_k')}",'{$seed}');

            setInterval("Flush()", 5000);
            setInterval("FlushEntrust()", 5000);

            if (document.getElementById("entrust") != null) {

                $("#entrust tr").css("cursor", "pointer");
                $("#entrust tr").click(function () {

                    var price = $(this).find("td:nth-child(2) em").html();
                    if (price != "") {

                        if (parseFloat(price) > parseFloat($("#limitUp").html())) {
                            price = $("#limitUp").html();
                        }
                        if (parseFloat(price) < parseFloat($("#limitDown").html())) {
                            price = $("#limitDown").html();
                        }

                        if ($(this).index() < 5) {
                            $("#BuyPrice").val(price);
                        }
                        else {
                            $("#SalePrice").val(price);
                        }

                    }
                });

                $("#SaleCount").val("");
                $("#BuyCount").val("");

                $("#BuyPrice").attr("maxlength", intFormatFloat);
				//$("#BuyPrice").attr("maxlength", $("#limitUp").html().length);
                $("#SalePrice").attr("maxlength", intFormatFloat);

                //设置默认价格

                var Sale1 = parseFloat($("#entrust tr:nth-child(5) td:nth-child(2) em").html());
                var Buy1 = parseFloat($("#entrust tr:nth-child(6) td:nth-child(2) em").html());
                var LimitUpPrice = parseFloat($("#limitUp").html());
                var LimitDownPrice = parseFloat($("#limitDown").html());
				
				//  现价：FlushPrice2
				var FlushPrice2 = parseFloat($("#FlushPrice2").html());


                if (isNaN(Sale1) || Sale1 > LimitUpPrice || Sale1 < LimitDownPrice) {
                    //$("#BuyPrice").val(LimitUpPrice.toFixed(BuySaleFloat));
					 $("#BuyPrice").val((FlushPrice2*0.99).toFixed(BuySaleFloat));
                } else {
                    $("#BuyPrice").val((Sale1*0.99).toFixed(BuySaleFloat));
                }

                if (isNaN(Buy1) || Buy1 > LimitUpPrice || Buy1 < LimitDownPrice) {
                    //$("#SalePrice").val(LimitDownPrice.toFixed(BuySaleFloat));
					 $("#SalePrice").val((FlushPrice2*1.01).toFixed(BuySaleFloat));
                } else {
                    $("#SalePrice").val((Buy1*1.01).toFixed(BuySaleFloat));
                }

            }

        });

        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }


        function Flush() {
            if(AutoFlush) {
                if ($('#mbtn').hasClass('select')) {
                    Minute('{$seed}',"{:U('User/ajax_min')}");
                }
                else if ($('#kbtn').hasClass('select')) {
                    KLine(  "{:U('User/ajax_k')}",'{$seed}');
                }
            }
        }

        function BuyPersent(per) {

            if (per == 1.0) {
                $("#BuyCount").css('color', '#FF0000');
            } else {
                $("#BuyCount").css('color', '#888');
            }

            var number = 0;
            var price = $('#BuyPrice').val();

            if (price == '' || price == 0) {
                if ($("#entrust tr:nth-child(5) td:nth-child(2) em").html() != "") {
                    $('#BuyPrice').val($("#entrust tr:nth-child(5) td:nth-child(2) em").html());
                    price = $("#entrust tr:nth-child(5) td:nth-child(2) em").html();
                }
                else {
                    //$('#BuyPrice').val($("#limitDown").html());
                    //price = $("#limitDown").html();
                    $('#BuyPrice').val($("#FlushPrice1").html())
                    price = $("#FlushPrice1").html();
                }
            }


            number = parseInt(hasmoney * per / price);

            $('#BuyCount').val(number);
            FlushBuyTotalMoney();
        }

        function SalePersent(per) {
            if (per == 1.0) {
                $("#SaleCount").css('color', '#FF0000');
            } else {
                $("#SaleCount").css('color', '#888');
            }
            var price = $('#SalePrice').val();
            var number = 0;
            if (price == '' || price == 0) {
                if ($("#entrust tr:nth-child(6) td:nth-child(2) em").html() != "") {
                    $('#SalePrice').val($("#entrust tr:nth-child(6) td:nth-child(2) em").html());
                    price = $("#entrust tr:nth-child(6) td:nth-child(2) em").html();
                }
                else {
                    //$('#SalePrice').val($("#limitUp").html());
                    //price = $("#limitUp").html();
                    $('#SalePrice').val($("#FlushPrice1").html());
                    price = $("#FlushPrice1").html();
                }
            }
            number = parseInt(hasnumber * per);
            if ('800001' != '900001' && '800001' != '800008'  && '800001' != '800013') {
                number = parseInt(number / 100) * 100;
            }

            if ('800001' == '800008' || '800001' == '800013') {
                number = parseInt(number / 10) * 10;
            }


            $('#SaleCount').val(number);
            FlushSaleTotalMoney();
        }

        function FlushBuyTotalMoney() {
            var number = $("#BuyCount").val();
            var price = $("#BuyPrice").val();
            $('#buytotalmoney').val((number * price).toFixed(intFormatFloat));
            $("#buytotalmoney").css('color', '#888');

            if ($('#buytotalmoney').val() - hasmoney >=0) {
                $("#buytotalmoney").css('color', '#FF0000');
            }
        }

        function FlushSaleTotalMoney() {
            var number = $("#SaleCount").val();
            var price = $("#SalePrice").val();
            var saletotalmoney = number * price;
            $('#saletotalmoney').val(saletotalmoney.toFixed(5));

            $('#salechargemoney').html((number * price * salecharge).toFixed(5));
        }

        function FormatFloatValue(value) {
            value = value.replace(/[^\d.]/g, "");
            value = value.replace(/^\./g, "");
            value = value.replace(/\.{2,}/g, ".");
            value = value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
            if (value.indexOf(".") != -1) {
                points = value.substring(value.indexOf("."));
                value = value.replace(points, "");
                //alert(points.length);
				//alert(intFormatFloat+1);
				if (points.length > intFormatFloat+1) {
                    points = points.substring(0, intFormatFloat+1);
                }
                value = value + points;
				
            }
            return value;
        }

        function FormatIntValue(value) {
            value = value.replace(/[^\d]/g, "");
            return value;
        }

        $("#BuyPrice").keyup(function () {
            $(this).val(FormatFloatValue($(this).val().toFixed(5)));
            FlushBuyTotalMoney();
        });

        $("#BuyCount").keyup(function () {
            $(this).val(FormatIntValue($(this).val()));
            $(this).css('color', '#888');
            var price = $("#BuyPrice").val();
            var maxnumber = parseInt((hasmoney / price));
            if ($(this).val() - maxnumber >= 0) {
                $(this).css('color', '#FF0000');
                $(this).val(maxnumber);
            }
            FlushBuyTotalMoney();
        });

        $("#BuyPrice").blur(function () {
            if ($(this).val() != "") {
                $(this).val(parseFloat($(this).val()).toFixed(5));
            }
            else if ($("#entrust tr:nth-child(5) td:nth-child(2) em").html() != "") {
                $(this).val($("#entrust tr:nth-child(5) td:nth-child(2) em").html());
            }
            else {
                // $(this).val($("#limitDown").html());
                $(this).val($("#FlushPrice1").html());
            }

            if (parseFloat($(this).val()) > parseFloat($("#limitUp").html()) || parseFloat($(this).val()) < parseFloat($("#limitDown").html())) {
                alert("委托价格不在今日涨跌停范围内");
                if ($("#entrust tr:nth-child(5) td:nth-child(2) em").html() != "") {
                    $(this).val($("#entrust tr:nth-child(5) td:nth-child(2) em").html());
                }
                else {
                    //$(this).val($("#limitDown").html());
                    $(this).val($("#FlushPrice1").html());
                }
            }
            FlushBuyTotalMoney();
        });

        $("#buytotalmoney").keyup(function () {

            $(this).val(FormatFloatValue($(this).val()));

            $(this).css('color', '#888');
            if($(this).val() - hasmoney > 0){
                $(this).css('color', '#FF0000');
                $(this).val(hasmoney);
            }

            //改变买入数量文本框的值
            var number = parseInt(parseFloat($(this).val()) / parseFloat($("#BuyPrice").val()) /100)*100;
            if(!isNaN(number)){
                $("#BuyCount").val(number);
            } else {
                $("#BuyCount").val("0");
            }


        });

        $("#saletotalmoney").keyup(function () {

            $(this).val(FormatFloatValue($(this).val()));

            var number = parseInt(parseFloat($(this).val()) / parseFloat($("#SalePrice").val()) /100)*100;

            if(!isNaN(number)){
                $("#SaleCount").val(number);
            } else {
                $("#SaleCount").val("0");
            }
            //
            $("#SaleCount").css('color', '#888');
            $(this).css('color', '#888');
            if(number > hasnumber){
                $("#SaleCount").css('color', '#FF0000');
                $("#SaleCount").val(parseInt(hasnumber/100)*100);
                $(this).css('color', '#FF0000');
                $(this).val(parseInt(hasnumber/100)*100*parseFloat($("#SalePrice").val()));
            }

            //

            $("#salechargemoney").html((parseFloat($(this).val()) * salecharge).toFixed(intFormatFloat));

        });

        $("#SalePrice").keyup(function () {
            $(this).val(FormatFloatValue($(this).val()));
            FlushSaleTotalMoney();
        });

        $("#SaleCount").keyup(function () {

            $(this).val(FormatIntValue($(this).val()));
            $(this).css('color', '#888');

            if ($(this).val() - hasnumber >= 0) {
                $(this).css('color', '#FF0000');
                $(this).val(hasnumber);
            }
            FlushSaleTotalMoney();
        });

        $("#SalePrice").blur(function () {
            if ($(this).val() != "") {
                $(this).val(parseFloat($(this).val()).toFixed(5));
            }
            else if ($("#entrust tr:nth-child(6) td:nth-child(2) em").html() != "") {
                $(this).val($("#entrust tr:nth-child(6) td:nth-child(2) em").html());
            }
            else {
                //$(this).val($("#limitUp").html());
                $(this).val($("#FlushPrice1").html());
            }
            if (parseFloat($(this).val()) > parseFloat($("#limitUp").html()) || parseFloat($(this).val()) < parseFloat($("#limitDown").html())) {
                alert("委托价格不在今日涨跌停范围内");

                if ($("#entrust tr:nth-child(6) td:nth-child(2) em").html() != "") {
                    $(this).val($("#entrust tr:nth-child(6) td:nth-child(2) em").html());
                }
                else {
                    //$(this).val($("#limitUp").html());
                    $(this).val($("#FlushPrice1").html());
                }
            }
            FlushSaleTotalMoney();
        });

        function FlushEntrust() {

            var  intFormatFloat = 5;

            //不在交易时间段不刷新
            var h = new Date().getHours();

           var sale_time_open = "{$OpenCloseTime.Open}";
           var sale_time_close = "{$OpenCloseTime.Close}"; 
   //         var sale_time_close = "24";

            if(h<sale_time_open || h > sale_time_close)
            {
                return false;
            }

            $("#entrust tr .td").css("transform","rotateX(.99turn)")

            $.post("{:U('User/FlushEntrust')}", { procode: '{$seed}' }, function (result) {

                $("#entrust tr td").css("transform","")

                var BuyList = result.data.BuyList;
                var SaleList = result.data.SaleList;
                var MarketInfo = result.data.MarketInfo;

                for(i in MarketInfo){
                    MarketInfo[i] = parseFloat(MarketInfo[i])
                }


                //刷新数据
                $("#FlushPrice1").html(MarketInfo.Price.toFixed(intFormatFloat));
                $("#FlushPrice2").html(MarketInfo.Price.toFixed(intFormatFloat));
                $("#FlushIncrease").html(MarketInfo.Increase.toFixed(intFormatFloat));
                $("#FlushIncreaseRate").html((MarketInfo.IncreaseRate * 100).toFixed(2) + "%");
                $("#FluashLowestPrice").html(MarketInfo.LowestPrice.toFixed(intFormatFloat));
                $("#FluashHighestPrice").html(MarketInfo.HighestPrice.toFixed(intFormatFloat));
                $("#FluashVolume").html(MarketInfo.Volume);


                //刷新样式
                if (MarketInfo.Price > MarketInfo.OpenPrice)
                {
                    $(".kline-head dt").attr("class", "color-1");
                    $("#FlushPrice2").attr("class", "color-1");

                }
                else if (MarketInfo.Price < MarketInfo.OpenPrice)
                {
                    $(".kline-head dt").attr("class", "color-4");
                    $("#FlushPrice2").attr("class", "color-4");
                }
                else
                {
                    $(".kline-head dt").removeAttr("class");
                    $("#FlushPrice2").removeAttr("class");
                }



                //卖 第5行到第1行
                for (i = 5; i >= 1; i--) {
                    if (i <= 5 - SaleList.length) {
                        $("#entrust tr:nth-child(" + i + ") td:nth-child(2)").html("<em></em>");
                        $("#entrust tr:nth-child(" + i + ") td:nth-child(3)").html("<em></em>");
                    }
                }
                for (i = 0; i < SaleList.length; i++) {
                    $("#entrust tr:nth-child(" + (5 - i).toString() + ") td:nth-child(2)").html("<em>" + parseFloat(SaleList[i].Price).toFixed(intFormatFloat) + "</em>");
                    $("#entrust tr:nth-child(" + (5 - i).toString() + ") td:nth-child(3)").html("<em>" + SaleList[i].Number + "</em>");

                    if (SaleList[i].Price > MarketInfo.OpenPrice) {
                        $("#entrust tr:nth-child(" + (5 - i).toString() + ") td:nth-child(2)").attr("class", "color-1");
                    }
                    else if (SaleList[i].Price < MarketInfo.OpenPrice) {
                        $("#entrust tr:nth-child(" + (5 - i).toString() + ") td:nth-child(2)").attr("class", "color-4");
                    } else {
                        $("#entrust tr:nth-child(" + (5 - i).toString() + ") td:nth-child(2)").removeAttr("class");
                    }


                }
                //买 第6行到第10行
                for (i = 6; i <= 10; i++) {
                    if (i >= 6 + BuyList.length) {
                        $("#entrust tr:nth-child(" + i + ") td:nth-child(2)").html("<em></em>");
                        $("#entrust tr:nth-child(" + i + ") td:nth-child(3)").html("<em></em>");
                    }
                }
                for (i = 0; i < BuyList.length; i++) {
                    $("#entrust tr:nth-child(" + (6 + i).toString() + ") td:nth-child(2)").html("<em>" + parseFloat(BuyList[i].Price).toFixed(intFormatFloat) + "</em>");
                    $("#entrust tr:nth-child(" + (6 + i).toString() + ") td:nth-child(3)").html("<em>" + BuyList[i].Number + "</em>");

                    if (BuyList[i].Price > MarketInfo.OpenPrice) {
                        $("#entrust tr:nth-child(" + (6 + i).toString() + ") td:nth-child(2)").attr("class", "color-1");
                    }
                    else if (BuyList[i].Price < MarketInfo.OpenPrice) {
                        $("#entrust tr:nth-child(" + (6 + i).toString() + ") td:nth-child(2)").attr("class", "color-4");
                    } else {
                        $("#entrust tr:nth-child(" + (6 + i).toString() + ") td:nth-child(2)").removeAttr("class");
                    }
                }


                $("#entrust em").addClass("flipy");



            }, "json");

        }

        function Buy() {
			var sweeping=$("#ch_buy").val();
            var price = parseFloat($("#BuyPrice").val());
            var upprice = parseFloat($("#limitUp").text());
            var downprice = parseFloat($("#limitDown").text());
            var number = parseInt($("#BuyCount").val());
            var buytotalmoney = (number * price).toFixed(intFormatFloat);

            if(isNaN(buytotalmoney)) {
                buytotalmoney = 0;
            }

            $("#buytotalmoney").val(buytotalmoney);

            if (price > upprice || price < downprice) {
                alert("委托价格超过今日价格限制");
                return false;
            }

            if ($("#BuyCount").val() == "" || $("#BuyCount").val() == 0) {
                alert("交易数量不正确");
                return false;
            }

			
			
            if ($("#BuyCount").val() % 100 != 0 ) {
                alert("交易数量不正确，必须是100的整倍。");
                return false;
            }

            if ($("#BuyCount").val() * $("#BuyPrice").val() - hasmoney>0) {
                alert("您的金币不足");
                return false;
            }

            if (confirm('买入信息确认\n--------------\n价格：' + $('#BuyPrice').val() + '\n数量：' + $('#BuyCount').val() + '\n　　　' + A2C(number) + '\n金币：' + buytotalmoney))
            {
                $("#SubmitType").val("BUY");
                $("#SaleCount").val("0");
                $.post(
                        "{:U('User/UserEntrustSubmit')}",
                        {num:number,type:1,trans_type:0,seed:"{$seed}",money:price,sweeping:sweeping},
                        function(data){
                            if(data.status == 1) {
                                $("#hasmoney").html(data.money)
                            }
                            alert(data.msg)
                        },'json'
                );
            }
        }

        function Sale() {
			_this = $(this);
			$(_this).attr("disabled",true);
			var sweeping=$("#ch_sale").val();
            var number = parseInt($("#SaleCount").val());
            var price = parseFloat($("#SalePrice").val());
            var upprice = parseFloat($("#limitUp").text());
            var downprice = parseFloat($("#limitDown").text());

            var saletotalmoney = (number * price).toFixed(intFormatFloat);

            if(isNaN(saletotalmoney)) {
                saletotalmoney = 0;
            }

            $("#saletotalmoney").val(saletotalmoney);

            var salechargemoney = (saletotalmoney * salecharge).toFixed(intFormatFloat);
            $("#salechargemoney").html(salechargemoney);

            if (price > upprice || price < downprice) {
                alert("委托价格超过今日价格限制");
                return false;
            }

            if ($("#SaleCount").val() == "" || $("#SaleCount").val() == 0) {
                alert("交易数量不正确");
                return false;
            }

			
			
            if ($("#SaleCount").val() % 100 != 0 ) {
                alert("交易数量不正确，必须是100的整倍。");
                return false;
            }

            if ($("#SaleCount").val() - hasnumber >0) {
                alert("您的持有量不足");
                return false;
            }

            if (confirm('卖出信息确认\n--------------\n价　格：' + $('#SalePrice').val() + '\n数　量：' + $('#SaleCount').val() + '\n　　　　' + A2C(number) + '\n金　币：' + saletotalmoney.toString() + '\n手续费：' + salechargemoney.toString()))
            {
                $("#SubmitType").val("SALE");
                $("#BuyCount").val("0");
                $.post(
                        "{:U('User/UserEntrustSubmit')}",
                        {num:number,type:0,trans_type:0,seed:"{$seed}",money:price,sweeping:sweeping},
                        function(data){
                            if(data.status == 1){
                                $("#hasnumber").html( data.num )
                            }
                            alert(data.msg);
							$(_this).attr("disabled",false);
                        },'json'
                );
            }
        }

        function Revoke(eId) {
            $("#EId").val(eId);
            $("#SubmitType").val("REVOKE");

            $("#BuyCount").val("0");
            $("#SaleCount").val("0");
            $("form").submit();
        }

        function Revokes(){

            if($("#EIds").val()==""){
                alert("请选择委托!");
                return false;
            }
            if (confirm('您确定取消选中委托？'))
            {
            }
        }

        //阿拉伯数字转换为简写汉字
        function A2C(Num) {
            for (i = Num.length - 1; i >= 0; i--) {
                Num = Num.replace(",", "")//替换Num中的“,”
                Num = Num.replace(" ", "")//替换Num中的空格
            }
            if (isNaN(Num)) { //验证输入的字符是否为数字
                //alert("请检查小写金额是否正确");
                return;
            }
            //字符处理完毕后开始转换，采用前后两部分分别转换
            part = String(Num).split(".");
            newchar = "";
            //小数点前进行转化
            for (i = part[0].length - 1; i >= 0; i--) {
                if (part[0].length > 10) {
                    //alert("位数过大，无法计算");
                    return "";
                }//若数量超过拾亿单位，提示
                tmpnewchar = ""
                perchar = part[0].charAt(i);
                switch (perchar) {
                    case "0":  tmpnewchar = "零" + tmpnewchar;break;
                    case "1": tmpnewchar = "一" + tmpnewchar; break;
                    case "2": tmpnewchar = "二" + tmpnewchar; break;
                    case "3": tmpnewchar = "三" + tmpnewchar; break;
                    case "4": tmpnewchar = "四" + tmpnewchar; break;
                    case "5": tmpnewchar = "五" + tmpnewchar; break;
                    case "6": tmpnewchar = "六" + tmpnewchar; break;
                    case "7": tmpnewchar = "七" + tmpnewchar; break;
                    case "8": tmpnewchar = "八" + tmpnewchar; break;
                    case "9": tmpnewchar = "九" + tmpnewchar; break;
                }
                switch (part[0].length - i - 1) {
                    case 0: tmpnewchar = tmpnewchar; break;
                    case 1: if (perchar != 0) tmpnewchar = tmpnewchar + "十"; break;
                    case 2: if (perchar != 0) tmpnewchar = tmpnewchar + "百"; break;
                    case 3: if (perchar != 0) tmpnewchar = tmpnewchar + "千"; break;
                    case 4: tmpnewchar = tmpnewchar + "万"; break;
                    case 5: if (perchar != 0) tmpnewchar = tmpnewchar + "十"; break;
                    case 6: if (perchar != 0) tmpnewchar = tmpnewchar + "百"; break;
                    case 7: if (perchar != 0) tmpnewchar = tmpnewchar + "千"; break;
                    case 8: tmpnewchar = tmpnewchar + "亿"; break;
                    case 9: tmpnewchar = tmpnewchar + "十"; break;
                }
                newchar = tmpnewchar + newchar;
            }
            //替换所有无用汉字，直到没有此类无用的数字为止
            while (newchar.search("零零") != -1 || newchar.search("零亿") != -1 || newchar.search("亿万") != -1 || newchar.search("零万") != -1) {
                newchar = newchar.replace("零亿", "亿");
                newchar = newchar.replace("亿万", "亿");
                newchar = newchar.replace("零万", "万");
                newchar = newchar.replace("零零", "零");
            }
            //替换以“一十”开头的，为“十”
            if (newchar.indexOf("一十") == 0) {
                newchar = newchar.substr(1);
            }
            //替换以“零”结尾的，为“”
            if (newchar.lastIndexOf("零") == newchar.length - 1) {
                newchar = newchar.substr(0, newchar.length - 1);
            }
            return newchar;
        }

        function GetMyEntrust(){

            FlushOther = true;
//  目前仅显示最新

            $.ajax({
                type: "post",
                url: "/Market/GetMyEntrust",
                datatype: "json",
                data: { ProductCode:'{$seed}' },
                beforeSend: function () {
                },
                complete: function () {
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                },
                success: function (result) {
                    var html = "";
                    if(FlushOther) {
                        $("#hasmoney").html(result.HasMoney.toFixed(5));
                        $("#hasnumber").html(result.HasNumber);
                    }

                    var items = result.List;
                    for(i=0;i<items.length;i++) {
                        var item = items[i];


                        var checked = ($("#EIds").val().indexOf("[" + item.Id + "]")!=-1) ? " checked=\"checked\"":"";
                        var checktd = (IsComplete==0) ? "<td><input type=\"checkbox\"" + checked + " value=\"" + item.Id + "\" /></td>" : "";


                        html = html + "<tr>";
                        html = html + checktd;
                        html = html + "<td>" + new Date(item.CreatedTime * 1000).Format("yyyy/M/d h:m:s") + "</td>";
                        html = html + "<td>" + item.ProductName + "</td>";
                        if (item.IsBuy) {
                            html = html + "<td><span  class=\"color-1\">买</span></td>";
                        }
                        else {
                            html = html + "<td><span  class=\"color-4\">卖</span></td>";
                        }
                        html = html + "<td>" + item.Price.toFixed(intFormatFloat) + "</td>";
                        html = html + "<td>" + item.Count + "</td>";
                        html = html + "<td>" + item.DeltCount + "</td>";
                        html = html + "<td>" + item.StatusCHI + "</td>";

                        if (item.Status == 0 || item.Status == 1) {
                            html = html + "<td><a onclick=\"if(confirm('确定撤销?')) {Revoke('" + item.Id + "')}\">撤消</a></td>";
                        }
                        else {
                            html = html + "<td>--</td>";
                        }

                        html = html + "</tr>";
                    }


                    var colspan = (IsComplete==0) ? 9 : 8;

                    if(html!="") {
                        $("#MyEntrust" + IsComplete.toString()).html(html);
                    } else {
                        $("#MyEntrust" + IsComplete.toString()).html("<tr><td class='algin' colspan='" + colspan + "'>没有查询到任何数据</td></tr>");
                    }

                    //分页

                    var PageCount = 0;
                    if(result.TotalRecordCount % result.PageSize == 0) {
                        PageCount = parseInt(result.TotalRecordCount / result.PageSize);
                    } else {
                        PageCount = parseInt(result.TotalRecordCount / result.PageSize + 1);
                    }

                    if(PageCount > 1) {
                        var page = "";
                        if(CurrentPageIndex>1){
                            page = "<span onclick='GetMyEntrust(" + IsComplete + ",10," + parseInt(CurrentPageIndex - 1).toString() + ",false)'>上一页</span>";
                        } else {
                            page = "<span class='none'>上一页</span>";
                        }

                        page = page + "<cite>" + CurrentPageIndex.toString() + "/" + PageCount.toString() + "</cite>";

                        if(CurrentPageIndex<PageCount){
                            page = page + "<span onclick='GetMyEntrust(" + IsComplete + ",10," + parseInt(CurrentPageIndex + 1).toString() + ",false)'>下一页</span>";
                        } else {
                            page = page + "<span class='none'>下一页</span>";
                        }

                        $("#thepager" + IsComplete.toString()).html(page);
                    } else {
                        $("#thepager" + IsComplete.toString()).hide();
                    }




                    $("#MyEntrust0 tr input[type='checkbox']").click(function() {
                        var eids =  $("#EIds").val();
                        var eid = $(this).val();

                        if($(this).is(':checked')){
                            if(eids.indexOf("[" + eid + "]")==-1){
                                $("#EIds").val(eids + "[" + eid + "]");
                            }
                        } else {
                            $("#EIds").val(eids.split("[" + eid + "]").join(''));
                        }

                    });

                },

            });
        }
    </script>

</block>
